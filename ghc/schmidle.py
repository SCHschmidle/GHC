import re
from datetime import datetime, timedelta
import requests
import urllib3
import os

urllib3.disable_warnings()

# Variables
i = 0
user = os.getlogin()
if user == "carcane":
    target_location = "Rotkreuz"
    walking_time = timedelta(minutes=7)
elif user == "schmidle" or user == "albissre":
    target_location = "Hellbühl"
    walking_time = timedelta(minutes=5)
target = timedelta(hours=8)
pause = timedelta()
lunch_time = timedelta(minutes=30)


# sTylyling
ascii_art=r"""
  _______   ______      __    __    ______    ___  ___   _______      ______     ___       __        ______ 
 /  _____| /  __  \    |  |  |  |  /  __  \  |   \/   | |   ____|    /      |   /   \     |  |      /      |
|  |  __  |  |  |  |   |  |__|  | |  |  |  | |  \  /  | |  |__      |  ,----'  /  ^  \    |  |     |  ,----'
|  | |_ | |  |  |  |   |   __   | |  |  |  | |  |\/|  | |   __|     |  |      /  /_\  \   |  |     |  |     
|  |__| | |  `--'  |   |  |  |  | |  `--'  | |  |  |  | |  |____    |  `----./  _____  \  |  `----.|  `----.
 \______|  \______/ [_]|__|  |__|  \______/  |__|  |__| |_______|[_] \______/__/     \__\ |_______| \______|
                                                                                                             
 -   ____________ ____________ ____________ 7 ____________ ____________ 7 ____________ ____________ ____________
--  / #  #  #  # ¦ #  #  #  # ¦ #  #  #  # ¦¨¦ #  #  #  # ¦ #  #  #  # ¦¨¦ #  #  #  # ¦ #  #  #  # ¦ #  #  #  # \ 
 -- °°¨¨¨¨¨¨¨¨¨¨¨°¨¨¨¨¨¨¨¨¨¨¨¨°¨¨¨¨¨¨¨¨¨¨¨¨°°°¨¨¨¨¨¨¨¨¨¨¨¨°¨¨¨¨¨¨¨¨¨¨¨¨°°°¨¨¨¨¨¨¨¨¨¨¨¨°¨¨¨¨¨¨¨¨¨¨¨¨°¨¨¨¨¨¨¨¨¨¨¨°°
"""
print("\033[0;94m" + ascii_art + "\033[0m")

print("------------------------------------------------------------------------------------------------------------------ \n \n")

text = input("Gib mir deine TimeTool Zeiten: ")
print()

# Regex ohne \b, nur nach Muster HH:MM suchen
zeiten = re.findall(r'\d{1,2}:\d{2}', text)

# In datetime-Objekte konvertieren
for zeit in zeiten:
    zeiten[i] = datetime.strptime(zeit, "%H:%M") # Start after lunch
    i += 1

i=2
# Lunch time berechnen
for j in range(0,int((len(zeiten)-1)/2)):
    pause = pause + zeiten[-1 * (i+1)]-zeiten[-1 *i]
    i = i+2

if pause > lunch_time:
    lunch_time = pause

# Differenz berechnen
print(f"Du hast \033[32m{pause}\033[0m gearbeitet")

end_time = zeiten[-1] + target + lunch_time
print(f"Du musst bis \033[31m{end_time.time()}\033[0m arbeiten")

r = requests.get(f"https://transport.opendata.ch/v1/connections?from=Buchrain&to=Hellbühl&time={(end_time + walking_time).strftime('%H:%M')}&limit=4", verify=False)
data = r.json()
print()
print("Nächste Abfahrten ab Buchrain:")
for verbindung in data["connections"]:
    abfahrt = datetime.fromisoformat(verbindung["from"]["departure"])
    print(f"  {abfahrt.strftime('%H:%M')} Uhr")
numbers_art = [
    [
    "00000000000000000000",
    "000000        000000",
    "0000   000000   0000",
    "000   00000000   000",
    "00   0000000000   00",
    "00   0000000000   00",
    "00   0000000000   00",
    "00   0000000000   00",
    "000   00000000   000",
    "0000   000000   0000",
    "000000        000000",
    "00000000000000000000"
    ],
    [
    "00000000000000000000",
    "000000     000000000",
    "0000   00  000000000",
    "00   0000  000000000",
    "000000000  000000000",
    "000000000  000000000",
    "000000000  000000000",
    "000000000  000000000",
    "000000000  000000000",
    "000000000  000000000",
    "00000000000000000000"
    ],
    [
    "00000000000000000000",
    "000000      00000000",
    "0000   0000    00000",
    "00   00000000   0000",
    "0000000000000   0000",
    "00000000000   000000",
    "000000000   00000000",
    "0000000   0000000000",
    "00000   000000000000",
    "000             0000",
    "00000000000000000000"
    ],

    [
    "00000000000000000000",
    "00000          00000",
    "0000000000000    000",
    "00000000000000  0000",
    "00000000000000   000",
    "00000          00000",
    "00000000000000   000",
    "00000000000000   000",
    "0000000000000    000",
    "00000          00000",
    "00000000000000000000"
    ],
    [
    "00000000000000000000",
    "000000      00000000",
    "00000   0   00000000",
    "0000   00   00000000",
    "000   000   00000000",
    "00               000",
    "000000000   00000000",
    "000000000   00000000",
    "000000000   00000000",
    "000000000   00000000",
    "00000000000000000000"
    ],
    [
    "00000000000000000000",
    "00              0000",
    "00   000000000000000",
    "00   000000000000000",
    "00             00000",
    "000000000000     000",
    "00000000000000   000",
    "0000000000000    000",
    "00000000000     0000",
    "00            000000",
    "00000000000000000000"
    ],
    [
    "00000000000000000000",
    "000000   00000000000",
    "00000   000000000000",
    "0000   0000000000000",
    "000   0      0000000",
    "00      000     0000",
    "00    0000000    000",
    "00   000000000   000",
    "000    00000    0000",
    "000000        000000",
    "00000000000000000000"
    ],
    [
    "00000000000000000000",
    "0000            0000",
    "000000000000   00000",
    "00000000000   000000",
    "0000000000   0000000",
    "0000            0000",
    "00000000   000000000",
    "0000000   0000000000",
    "000000   00000000000",
    "00000   000000000000",
    "00000000000000000000"
    ],

    [
    "00000000000000000000",
    "000000        000000",
    "0000   000000   0000",
    "000   00000000   000",
    "0000   000000   0000",
    "00000          00000",
    "0000   000000   0000",
    "000   000000000   00",
    "0000   0000000   000",
    "000000        000000",
    "00000000000000000000"
    ],
    [
    "00000000000000000000",
    "000000        000000",
    "0000   000000   0000",
    "000   00000000   000",
    "0000   000000   0000",
    "000000         00000",
    "00000000000   000000",
    "00000000000   000000",
    "0000000000   0000000",
    "000000000   00000000",
    "00000000000000000000"
    ]
]
x = re.findall(r"\d", end_time.strftime("%H%M"))
if user == "schmidle":
    print("\033[0;94m")
    for i in range(11):
        for digit in x:
            digit = int(digit)
            print(numbers_art[digit][i], end="")
        print()